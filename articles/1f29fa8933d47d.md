---
title: "MySQL9.0ã®æ–°æ©Ÿèƒ½ Saving JSON output from EXPLAIN ANALYZE INTO ã‚’è§¦ã£ã¦ã¿ã‚‹"
emoji: "ğŸ¬"
type: "tech"
topics: ["MySQL", "Docker"]
published: true
publication_name: "gmomedia"
---

## MySQL9.0 ç™»å ´ï¼
2024/07/01ã«MySQL9.0ãŒOracleã‚ˆã‚Šãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹ã®æœ€æ–°ç‰ˆã§ã™ã€‚  

https://dev.mysql.com/doc/refman/9.0/en/mysql-nutshell.html

## ä¸»ãªæ–°æ©Ÿèƒ½
- JavaScript stored programs(ã‚¨ãƒ³ãƒ—ãƒ©ã®ã¿)
- VECTOR type suport
- Saving JSON output from EXPLAIN ANALYZE INTO

æ–°æ©Ÿèƒ½ã®ä¸­ã§ã‚‚ã€Saving JSON output from EXPLAIN ANALYZE INTOã¯æ°—è»½ã«è©¦ã›ãã†ãªã®ã§å®Ÿé¨“ã—ã¦ã¿ã¾ã™ã€‚

## Saving JSON output from EXPLAIN ANALYZE INTO
### EXPLAINã¨EXPLAIN ANALYZEã®é•ã„
- EXPLAINã¯ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹å‰ã®è¨ˆç”»ã‚’å‡ºåŠ›ã™ã‚‹ã€‚ï¼ˆã‚ˆãå®Ÿè¡Œè¨ˆç”»ã¨è¨€ã‚ã‚Œã‚‹ï¼‰
- EXPLAIN ANALYZEã¯å®Ÿéš›ã«ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€ãã®å®Ÿè¡Œæ™‚é–“ãªã©ã‚’å‡ºåŠ›ã™ã‚‹ã€‚

ãã—ã¦ã€MySQL9.0ã§ã¯`EXPLAIN ANALYZE FORMAT=JSON`ã®çµæœã‚’ãƒ¦ãƒ¼ã‚¶å¤‰æ•°ã«æ ¼ç´ã™ã‚‹æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚  
ä½•ã‹ã—ã‚‰ã®é‡ã„ã‚¯ã‚¨ãƒªã®èª¿æŸ»ã‚’ã—ãŸã„éš›ã«ä»•è¾¼ã‚“ã¦ãŠãã¨ä¾¿åˆ©ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã­ã€‚  
å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ‰ãƒ©ã‚¤ãƒã®ç”¨æ„
æ–°ã—ã„æ§‹æ–‡ã¯ã€å¤ã„ãƒ‰ãƒ©ã‚¤ãƒã§å‘¼ã³å‡ºãã†ã¨ã—ã¦ã‚‚æœªçŸ¥ã®æ§‹æ–‡ãªã®ã§å¤±æ•—ã—ã¾ã—ãŸã€‚
ä»Šå›ã¯Macã§DataGripã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ ã¾ãšã¯MySQL9.0ã«å¯¾å¿œã—ãŸãƒ‰ãƒ©ã‚¤ãƒã‚’ç”¨æ„ã—ã¾ã™ã€‚  
https://dev.mysql.com/downloads/connector/j/

![](/images/1f29fa8933d47d/mysql9_driver1.png)

1. Select Operating System:ã¯ `Platform Independent`ã‚’é¸æŠ
1. Platform Independent (Architecture Independent), ZIP Archive ã‚’é©å½“ãªå ´æ‰€ã«ä¿å­˜
1. DataGripã®Data Source and Driversã®Driversã‚¿ãƒ–ã§UserDriversã‚’æ–°è¦ä½œæˆ
1. Driver Filesã®ï¼‹ãƒœã‚¿ãƒ³ã§Custom JASs... ã§å…ˆç¨‹ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‰ãƒ©ã‚¤ãƒã®Jarã‚’é¸æŠ
1. ã‚¯ãƒ©ã‚¹ã¯`com.mysql.jdbc.Driver`
![](/images/1f29fa8933d47d/mysql9_driver2.png)
1. ã‚ã¨ã¯DataSourcesã§å…ˆç¨‹ä½œæˆã—ãŸDriverã‚’é¸æŠã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚Œã°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®æº–å‚™ã¯OKã§ã™ã€‚
![](/images/1f29fa8933d47d/mysql9_driver3.png)


### ã‚µãƒ¼ãƒãƒ¼ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°ã®è¨­å®š
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€mysql9.0ã§ã‚ã£ã¦ã‚‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`explain_json_format_version`ãŒ1ã«ãªã£ã¦ãŠã‚Šã€ä¸Šè¨˜æ–°æ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“
```SQL
test_schema> EXPLAIN ANALYZE FORMAT=JSON INTO @variables SELECT * FROM item Where name like 'å•†å“%'
[2024-07-19 11:38:57] [0A000][6412] EXPLAIN ANALYZE does not support FORMAT=JSON with explain_json_format_version=1.
```
ã‚µãƒ¼ãƒãƒ¼ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°ã‚’æ›¸ãæ›ãˆã¦æ–°æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```sh :my.cnf
[mysqld]
explain_json_format_version = 2
```

```SQL
test_schema> EXPLAIN ANALYZE FORMAT=JSON INTO @variables SELECT * FROM item Where name like 'å•†å“%'
[2024-07-19 11:41:26] 33 ms ã§å®Œäº†ã—ã¾ã—ãŸ
```

### EXPLAIN ANALYZE INTOçµæœã®INSERTã‚’è©¦ã—ã¦ã¿ã‚‹

```SQL:ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE analysis (
    id SERIAL PRIMARY KEY AUTO_INCREMENT,
    analysis JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO item () VALUES ();
INSERT INTO item (id) SELECT 0 FROM item;
INSERT INTO item (id) SELECT 0 FROM item;
INSERT INTO item (id) SELECT 0 FROM item;
INSERT INTO item (id) SELECT 0 FROM item;
INSERT INTO item (id) SELECT 0 FROM item;
INSERT INTO item (id) SELECT 0 FROM item;

UPDATE item SET
  name = CONCAT('å•†å“', id),
  description = SUBSTRING(MD5(RAND()), 1, 30),
  price = CEIL(RAND() * 10000),
  created_at = ADDTIME(CONCAT_WS(' ','2014-01-01' + INTERVAL RAND() * 180 DAY, '00:00:00'), SEC_TO_TIME(FLOOR(0 + (RAND() * 86401))));
```
ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã•ã›ã¦é ‚ãã¾ã—ãŸã€‚
[https://tech.kurojica.com/archives/29823/](https://tech.kurojica.com/archives/29823/)

```SQL:EXPLAIN ANALYZE INTOçµæœã®INSERTã‚’è©¦ã—ã¦ã¿ã‚‹
EXPLAIN ANALYZE FORMAT=JSON INTO @variables SELECT * FROM item Where name like 'å•†å“%';
INSERT INTO analysis (analysis) VALUES (@variables);

SELECT * FROM analysis;
```

```JSON:çµæœ
{
    "query": "/* select#1 */ select `test_schema`.`item`.`id` AS `id`,`test_schema`.`item`.`name` AS `name`,`test_schema`.`item`.`description` AS `description`,`test_schema`.`item`.`price` AS `price`,`test_schema`.`item`.`created_at` AS `created_at` from `test_schema`.`item` where (`test_schema`.`item`.`name` like 'å•†å“%')",
    "inputs": [
        {
            "operation": "Table scan on item",
            "table_name": "item",
            "access_type": "table",
            "actual_rows": 32768,
            "schema_name": "test_schema",
            "actual_loops": 1,
            "used_columns": [
                "id",
                "name",
                "description",
                "price",
                "created_at"
            ],
            "estimated_rows": 34083,
            "actual_last_row_ms": 21.819370000000003,
            "actual_first_row_ms": 0.173959,
            "estimated_total_cost": 3480.55
        }
    ],
    "condition": "(item.`name` like 'å•†å“%')",
    "operation": "Filter: (item.`name` like 'å•†å“%')",
    "query_type": "select",
    "access_type": "filter",
    "actual_rows": 32768,
    "actual_loops": 1,
    "estimated_rows": 3786.621406450868,
    "filter_columns": [
        "test_schema.item.`name`"
    ],
    "actual_last_row_ms": 28.602702,
    "actual_first_row_ms": 0.179834,
    "estimated_total_cost": 3480.55
}
```

é‡ãŸã„ã‚¯ã‚¨ãƒªã‚’èª¿æŸ»ã™ã‚‹éš›ã‚„ã€å®Ÿè¡Œã—ãŸçµæœã®ã‚³ã‚¹ãƒˆãªã©ã‚’èª¿æŸ»ã—ãŸã„éš›ã«ä¾¿åˆ©ã§ã™ã­ã€‚  
ã‚¹ãƒ­ãƒ¼ãƒ­ã‚°ã¨ä½µç”¨ã™ã‚‹ã¨ä¾¿åˆ©ãã†ã§ã™ã€‚  
GAã¯ã¾ã ã¾ã å…ˆã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒã€ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«æœŸå¾…ã§ã™ã€‚