---
title: "ã‚¿ã‚¹ã‚¯ç®¡ç†ã¨ã‚¿ã‚¹ã‚¯ã‚’ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ã™ã‚‹Slackã‚¢ãƒ—ãƒªã‚’ä½œã£ã¦ã¿ãŸ"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Slack","Slackã‚¢ãƒ—ãƒª","SlackBolt","Python", "AI"]
published: false
publication_name: "gmomedia"
---

## Slackã‚¢ãƒ—ãƒªã¨ã¯

Slackã‚¢ãƒ—ãƒªã¨ã¯ã€Slackä¸Šã§æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚  
Slackã«ã¯GUIã§æ“ä½œã§ãã‚‹ã“ã¨ã®ã»ã¨ã‚“ã©ã‚’APIã§ã‚‚æ“ä½œå¯èƒ½ã§ã™ã€‚
æ§˜ã€…ãªã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰Slackã‚¢ãƒ—ãƒªãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãŠã™ã™ã‚ã®ã‚¢ãƒ—ãƒªã‚’ã„ãã¤ã‹ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ã¿ã¾ã™ã€‚

- [Github](https://gmo-media.slack.com/apps/A01BP7R4KNY-github)
  
  - Githubã§ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã€PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ã«ã‚¢ã‚µã‚¤ãƒ³é€šçŸ¥ã€æ”¾ç½®ã—ã¦ã„ã‚‹PRãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©ã‚’é€šçŸ¥ã—ã¦ãã‚Œã¾ã™ã€‚

- [Google Calendar](https://gmo-media.slack.com/apps/ADZ494LHY-google-calendar?tab=more_info)

  - Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’Slackã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚ãƒªãƒã‚¤ãƒ³ãƒ‰æ©Ÿèƒ½ã‚‚ã¤ã„ã¦ã„ã¾ã™ã€‚

- [Polly](https://gmo-media.slack.com/apps/A04E6JX41-polly)
  
  - Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã§æ°—è»½ã«æŠ•ç¥¨æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™ã€‚ã‚¤ãƒ™ãƒ³ãƒˆã‚„é£²ã¿ä¼šã«å‚åŠ ã§ãã‚‹äººã«å‚åŠ å¯èƒ½æ—¥ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’æ°—è»½ã«å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ 



## Slackã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã®æ¦‚è¦
ã€Œãƒªãƒã‚¤ãƒ³ã¡ã‚ƒã‚“ã€ ã¨ã„ã†Slackä¸Šã§å®Œçµã™ã‚‹ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã‚’å†…è£½ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½œæˆã—ã¾ã—ãŸã€‚  
Slackä¸Šã®ä»»æ„ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒªãƒã‚¤ãƒ³ã¡ã‚ƒã‚“ã‚’é¸æŠã™ã‚‹ã¨è‡ªå‹•ã§ã‚¿ã‚¹ã‚¯ç™»éŒ²ã•ã‚Œã¾ã™ã€‚  
ç¤¾å†…ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½œæˆã—ãŸãŸã‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨ã¦ã¯å‡ºã›ã¾ã›ã‚“ãŒã€ã„ã¤ã‹ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«ã—ã¦ã‚‚è‰¯ã„å½¢ã§å…¬é–‹ã—ãŸã„æ°—æŒã¡ã€‚

![](/images/slackapp_1.png)
![](/images/slackapp_2.png)


ã¾ãŸã€ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœŸé™ã¨ã¯AIï¼ˆGPT-4oï¼‰ã§è‡ªå‹•åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚
ã‚¿ã‚¹ã‚¯ç™»éŒ²å¾Œã«ä½¿ãˆã‚‹æ©Ÿèƒ½ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™  

- æœŸé™ã®ä¿®æ­£æ©Ÿèƒ½
- æœªå®Œäº†è€…ã®ä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸäººã®ã¿è¡¨ç¤ºï¼‰
- æœªå®Œäº†è€…ã¸ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’é£›ã°ã™æ©Ÿèƒ½
- æœªå®Œäº†è€…ã¸ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’é€ã‚‹æ©Ÿèƒ½ï¼ˆãƒãƒƒãƒå‡¦ç†ï¼‰
- Slackã‚¢ãƒ—ãƒªãƒ›ãƒ¼ãƒ ã‹ã‚‰è‡ªåˆ†è‡ªèº«ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½è·¡ã™ã‚‹æ©Ÿèƒ½
- ãƒãƒ£ãƒ³ãƒãƒ«å†…ã§ã‚¢ãƒ—ãƒªã«å¯¾ã—ã¦ã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ã™ã‚‹ã¨ã€ãã®ãƒãƒ£ãƒ³ãƒãƒ«ã§ç™ºç”Ÿã—ãŸã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½


## ä½¿ç”¨æŠ€è¡“
- SlackApp
- Python
- Slack Boltï¼ˆfor Pythonï¼‰
- MySQL 8.4 LTS
- ORM SQLAlchemy
- Docker
- Azure OpenAI Serviceï¼ˆAssistants APIã‚’ä½¿ç”¨ï¼‰

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

![](/images/slackapp_arch.png)

- ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç”¨ã‚¢ãƒ—ãƒª

  - Slackã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘æ­¢ã‚ã‚‹ã‚¢ãƒ—ãƒª
  - WebSocketé€šä¿¡ã§Slackã¨é€šä¿¡

- ãƒãƒƒãƒç”¨ã‚¢ãƒ—ãƒª

  - ã‚¿ã‚¹ã‚¯æœªå®Œäº†è€…ã«å®šæœŸçš„ã«ãƒªãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒª
  - nginxã§ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã—ã¦ã„ã‚‹
  - åŒã˜ConoHaã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§ç¨¼åƒã—ã¦ã„ã‚‹Rundeckã‹ã‚‰ãƒãƒƒãƒã‚¢ãƒ—ãƒªã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«GETã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ


## ERå›³
![](/images/slackapp_4.png)

ã‚¿ã‚¹ã‚¯ç™»éŒ²ã™ã‚‹éš›ã«ã€ã‚¿ã‚¹ã‚¯å…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ts(ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—)ã‚’å–å¾—ã—DBã«è¨˜éŒ²ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€ã‚¿ã‚¹ã‚¯ãã®ã‚‚ã®ã®å®Œäº†çŠ¶æ³ï¼ˆtask_list.is_closed)ã‚’è¨­å®šã€‚  
task_listã®task_idã¨å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã§ç´ã¥ã‘ãŸuser_task_statusã«ãƒ¦ãƒ¼ã‚¶ã”ã¨ã®ã‚¿ã‚¹ã‚¯çµ‚äº†çŠ¶æ³ã‚’ä¿æŒã€‚  
specfic_channnelã«ã¯ã€ç‰¹å®šã®ãƒãƒ£ãƒ³ãƒãƒ«ã§ã¯ã‚¿ã‚¹ã‚¯ç™»éŒ²ã•ã›ãªã„ãªã©ã®åˆ¶å¾¡ã‚’å…¥ã‚ŒãŸã„å ´åˆã«ä½¿ç”¨ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚  
ai_promptã¯å¾Œè¿°ã®Azure OpenAI Serviceã§æ´»ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚


## æ´»ç”¨ã—ãŸæ©Ÿèƒ½ã€ç‰¹ç­†ã™ã¹ãç‚¹ãªã©
### Azure OpenAI Serviceã®æ´»ç”¨
ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²ã™ã‚‹éš›ã«æœŸé™ã‚„ã‚¿ã‚¤ãƒˆãƒ«ãªã©ã‚’æ‰‹å…¥åŠ›ã™ã‚‹ã“ã¨ãªãã€ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç™»éŒ²ã™ã‚‹ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã“ã¨ãŒã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ã²ã¨ã¤ã§ã—ãŸã€‚  
ãã‚Œã‚’å¶ãˆã‚‹ãŸã‚ã«æ´»ç”¨ã—ãŸã®ãŒAzure OpenAI Serviceï¼ˆAOAIï¼‰ã§ã™ã€‚  
å°†æ¥ã®æ©Ÿèƒ½æ‹¡å……ã«å‚™ãˆã¦AssistantsAPIã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
```json
æ–‡ç« ã‚’èª­ã¿å–ã‚Šã€JSONå½¢å¼ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚
    due_dateã¯yyyy-MM-dd hh:mmå½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
    æ™‚é–“æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä¸€å¾‹åˆå¾Œ19:00ã¨ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚
    æ˜æ—¥ã‚„æ˜å¾Œæ—¥ã¨ã„ã†è¡¨ç¾ã®å ´åˆã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’åŸºæº–ã«ã—ã¦ãã ã•ã„ã€‚

    ä¾‹
    {
        "title": "PCã®è¿”å´æœŸé™ã«ã¤ã„ã¦",
        "due_date": "2024-06-06",
    }'
ä»Šæ—¥ã®æ—¥ä»˜ã¯mmæœˆddæ—¥ã§ã™
```
`ä»Šæ—¥ã®æ—¥ä»˜ã¯mmæœˆddæ—¥ã§ã™`ã®éƒ¨åˆ†ã¯Pythonã‚¢ãƒ—ãƒªå´ã‹ã‚‰å‹•çš„ã«ã‚³ãƒ¼ãƒ‰ã‚’å·®ã—è¾¼ã‚€ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯Pythonã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã®ã§ã¯ãªãã€DBã«ä¿ç®¡ã™ã‚‹ã“ã¨ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç°¡å˜ã«å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

#### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
```Python
from openai import AzureOpenAI

from service.db_service import DBService


class AzureOpenService:
    def __init__(self):
        self.openai_client = AzureOpenAI(
            api_key=os.getenv("AZURE_OPENAI_API_KEY"),
            api_version="2024-05-01-preview",
            azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT"),
        )
        self.db_service = DBService()

    def extract_title_and_duedate(self, message: str) -> str:
        """Promptã‚’å…ƒã«completionsã‚’ç”Ÿæˆã™ã‚‹"""

        if "ã€TESTã€‘" in message:
            # é–‹ç™ºæ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹
            return {
                "title": "ã€TESTã€‘PCã®è¿”å´æœŸé™ã«ã¤ã„ã¦",
                "due_date": "2024-06-06 10:00",
            }

        # AliasãŒç‰¹å®šã®å€¤ã«ä¸€è‡´ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªã‚’æ¤œç´¢(DBã®ä¸­ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ›¸ã„ã¦ã„ã¾ã™)
        ai_prompts = self.db_service.fetch_ai_prompt_by_alias("CREATE_TASK")

        response = self.openai_client.chat.completions.create(
            model=os.getenv("AZURE_OPENAI_MODEL"),
            messages=[
                {"role": "system", "content": f"æŒ‡ç¤º: {ai_prompts[0].prompt} ä»Šæ—¥ã®æ—¥ä»˜: {datetime.now()}ã§ã™"},
                {"role": "user", "content": message},
            ],
        )
        message_info = response.choices[0].message.content[
            response.choices[0].message.content.find("{") : response.choices[0].message.content.rfind("}") + 1
        ]

        return json.loads(message_info)
```


### Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã® ã€Œã‚ãªãŸã ã‘ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€æ©Ÿèƒ½
ã‚¿ã‚¹ã‚¯ã®æœªå¯¾å¿œè€…ä¸€è¦§ã‚’ç¢ºèªã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚  
ç”»åƒã®ã‚ˆã†ã«æœªå¯¾å¿œè€…ã‚’è¡¨ç¤ºã•ã›ãŸã‹ã£ãŸã®ã§ã™ãŒã€æ¯åº¦ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ è€…ãŒè¦‹ãˆã‚‹å½¢ã§æŠ•ç¨¿ã•ã‚Œã‚‹ã¨ãƒã‚¤ã‚ºã¨ãªã‚‹ãŸã‚ã€
chat_postEphemeralã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Œã‚ãªãŸã ã‘ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€ã¨ã„ã†å½¢ã§æŠ•ç¨¿ã•ã‚Œã¾ã™ã€‚

![](/images/slackapp_3.png)
@[card](https://api.slack.com/methods/chat.postEphemeral)


```python
def chat_post_ephemeral(self, channel, user, thread_ts, text, blocks=None):
    """ç‰¹å®šäººç‰©ã®ã¿è¦‹ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹"""
    return self.app.client.chat_postEphemeral(
        channel=channel,
        user=user,
        thread_ts=thread_ts,
        text=text,
        blocks=blocks,
    )
```
### WebSocketã§ã®é€šä¿¡
Slackã‚¢ãƒ—ãƒªã§ã¯ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã“ã¡ã‚‰ã§ç«‹ã¦ã¦åˆ©ç”¨ã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã¨  
WebSocketã‚’ä½¿ã£ãŸãƒ¢ãƒ¼ãƒ‰ã®2ã¤ãŒã‚ã‚Šã¾ã™ã€‚  
ã©ã¡ã‚‰ã®ãƒ¢ãƒ¼ãƒ‰ã«ã‚‚ãã‚Œãã‚Œãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ãŒã€WebSocketã®ãƒ¡ãƒªãƒƒãƒˆã¯  
- ã‚µãƒ¼ãƒå´ã§ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã®ãƒãƒ¼ãƒˆé–‹æ”¾ã‚’ã—ãªãã¦è‰¯ã„
- è¨¼æ˜æ›¸ãªã©ã®è¨­å®šãŒä¸è¦

ãªã©ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚ä»Šå›ã€Dockerã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚docker-compose.ymlã§WebSocketç”¨ã®ãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã—ã¦ã„ã¾ã™ãŒã€  
ConoHaï¼ˆVer.2ï¼‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šã§ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã¯è¨±å¯ã—ãªã„è¨­å®šã«ã—ã¦ã„ã¾ã™ã€‚

```yml
services:
  slack-task-handler-app:
    container_name: slack_task_handler_app
    build:
      context: .
      dockerfile: Dockerfile.slack_handler
    depends_on:
      - slack-task-app-mysqld
    environment:
      TZ: Asia/Tokyo
    ports:
      - "444:443" # ã“ã“
    networks:
      - slack-task-app-network
    restart: always
    volumes:
      - ./app/logs:/usr/src/app/logs
```
â€»æœ¬æ¥444ã¯SNPPã®ãŸã‚ã®ãƒãƒ¼ãƒˆã‚‰ã—ã„ã§ã™ãŒã€ãƒ›ã‚¹ãƒˆOSã®443ã‚’ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚444ã«è¨­å®š

:::message
0-1023ã®ç¯„å›²ã®ãƒãƒ¼ãƒˆç•ªå·ã®ã“ã¨ã‚’æœ€è¿‘ã§ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒˆã¨ã„ã†ã‚‰ã—ã„ã§ã™ã€‚  
ã„ã¤ã®ã¾ã«ã‹ã‚¦ã‚§ãƒ«ãƒã‚¦ãƒ³ãƒãƒ¼ãƒˆã¨ã„ã†è¨€ã„æ–¹ã§ã¯ãªããªã£ã¦ã¾ã—ãŸã€‚  
[Service Name and Transport Protocol Port Number Registry](https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml)
:::





## å‚è€ƒã«ã—ãŸã‚µã‚¤ãƒˆ
- [Bolt for Python](https://slack.dev/bolt-python/ja-jp/tutorial/getting-started)

  - Boltã®å…¬å¼ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚Boltã§Slackã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã™ã‚‹å ´åˆã¯å¿…èª­ã§ã™ã€‚


- [Slack Block Kit Builder](https://app.slack.com/block-kit-builder)

  - Slackå…¬å¼ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ä½œæˆã‚’æ”¯æ´ã—ã¦ãã‚Œã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  
  Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã‚¢ãƒ—ãƒªãƒ›ãƒ¼ãƒ ã¯ã€Blockã®ä¸­èº«ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã“ã¨ã§è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚

- [Slack API](https://api.slack.com/automation/quickstart)

  - SlackAPIã®ã™ã¹ã¦ãŒã“ã“ã«ã€‚
